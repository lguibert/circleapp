{% extends 'base.html' %}

{% block content %}
    <div class="container-fluid" id="home">
        <div class="row">
            <div class="col-xs-12">
                <div class="panel panel-info">
                    <div class="panel-heading">
                        <h4>Go go go</h4>
                    </div>
                    <div class="panel-body">
                        <div class="row controllersContainer">
                            <form id="searchForm">
                                <div class="col-xs-12 col-lg-3">
                                    <div class="row">
                                        <div class="form-group col-xs-6">
                                            <label for="daySelector">Jour</label>
                                            <select id="daySelector" class="form-control">
                                                <option></option>
                                            </select>
                                        </div>
                                        <div class="form-group col-xs-6">
                                            <label for="datetimeSelector">Heure</label>
                                            <input type='text' class="form-control" id='timeSelector'/>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-xs-12 col-lg-3">
                                    <div class="form-group">
                                        <label for="types">Type de cours</label>
                                        <select name="types" id="types" class="form-control">
                                            <option></option>
                                            {% for type in types %}
                                                <option value="{{ type.id }}">{{ type.name }}</option>
                                            {% endfor %}
                                        </select>
                                    </div>
                                </div>
                                <div class="col-xs-12 col-lg-3">
                                    <div class="form-group">
                                        <label for="rooms">Salles</label>
                                        <select name="rooms" id="rooms" class="form-control">
                                            <option></option>
                                            {% for room in rooms %}
                                                <option value="{{ room.id }}">{{ room.name }}</option>
                                            {% endfor %}
                                        </select>
                                    </div>
                                </div>
                                <div class="col-xs-12 col-lg-3">
                                    <div class="form-group">
                                        <label style="visibility: hidden">Lancer recherche</label>
                                        <button class="btn btn-success form-control">Go&nbsp;!
                                        </button>
                                    </div>
                                </div>
                            </form>
                        </div>
                    </div>
                </div>
            </div>

            <div class="col-xs-12">
                <div class="panel panel-success">
                    <div class="panel-heading">
                        <h4>Et tu peux aller...</h4>
                    </div>
                    <div class="panel-body row" id="target">

                    </div>
                </div>
            </div>
        </div>
    </div>
{% endblock %}

{% block extrajs %}
    <script>
        $(document).ready(function () {
            var days = ["Lundi", "Mardi", "Mercredi", "Jeudi", "Vendredi", "Samedi", "Dimanche"];
            var $daySelector = $("#daySelector");
            var FORMAT_DATE = "DD/MM/YYYY HH:mm";
            var $target = $("#target");

            for (var i = 0; i < days.length; i++) {
                $daySelector.append("<option id='" + i + "'>" + days[i] + "</option>");
            }

            $('#timeSelector').datetimepicker({
                step: 15,
                datepicker: false,
                format: "H:i"

            });

            function createBlockCourse(course) {
                console.log(course);
                return "<div class='col-xs-2'><div class='panel panel-default coursePanel'>" +
                    "<div class='panel-heading'>" + course.name + "</div>" +
                    "<div class='panel-body'>" +
                    "<ul>" +
                    "<li>Debut: " + moment.parseZone(course.start_date).format(FORMAT_DATE) + "</li>" +
                    "<li>Fin: " + moment.parseZone(course.end_date).format(FORMAT_DATE) + "</li>" +
                    "</ul>" +
                    "</div>" +
                    "</div></div>";
            }

            function generateCourse(data) {
                $target.empty();
                for (var i = 0; i < data.length; i++) {
                    console.log(i)
                    curData = data[i];
                    console.log(curData);
                    $target.append(createBlockCourse(curData));
                }
            }

            $("#searchForm").on("submit", function (e) {
                e.preventDefault();

                $.ajax({
                    url: "{% url 'searchCourses' %}",
                    method: "POST",
                    data: {
                        day: $("#daySelector").val(),
                        time: $("#timeSelector").val(),
                        type: $("#types").val(),
                        room: $("#rooms").val(),
                        csrfmiddlewaretoken: "{{ csrf_token }}"
                    }
                }).done(function (data) {
                    console.log("SUCCESS");
                    console.log(data, data.length);
                    if(data.courses && data.courses !== 0){
                        generateCourse(data.courses);
                    }else{
                        toastr.error('Aucun cours pour les données sélectionnées.', 'Aie!')
                    }
                }).fail(function (data) {
                    console.log("ERROR");
                    console.log(data);
                })
            })
        });
    </script>
{% endblock %}